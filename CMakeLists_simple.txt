cmake_minimum_required(VERSION 3.20)
project(LiveTextSystem)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Find packages
find_package(PkgConfig REQUIRED)
find_package(OpenGL REQUIRED)
find_package(glfw3 REQUIRED)

# freetype
pkg_check_modules(FREETYPE REQUIRED freetype2)

# For testing without Aeron, we'll create stub implementations
add_definitions(-DTESTING_MODE)

# imgui - Download if not present
set(IMGUI_DIR ${CMAKE_CURRENT_SOURCE_DIR}/third_party/imgui)
if(NOT EXISTS ${IMGUI_DIR})
    message(STATUS "Downloading ImGui...")
    execute_process(
        COMMAND git clone --depth 1 --branch v1.90 https://github.com/ocornut/imgui.git ${IMGUI_DIR}
        WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/third_party
    )
endif()

file(GLOB IMGUI_SOURCES
    ${IMGUI_DIR}/*.cpp
    ${IMGUI_DIR}/backends/imgui_impl_glfw.cpp
    ${IMGUI_DIR}/backends/imgui_impl_opengl3.cpp
)

# gl3w - simple OpenGL loader
set(GL3W_DIR ${CMAKE_CURRENT_SOURCE_DIR}/third_party/gl3w)
if(NOT EXISTS ${GL3W_DIR})
    message(STATUS "Setting up gl3w...")
    file(MAKE_DIRECTORY ${GL3W_DIR}/include/GL)
    file(MAKE_DIRECTORY ${GL3W_DIR}/src)

    # Download gl3w files
    file(DOWNLOAD
        "https://raw.githubusercontent.com/skaslev/gl3w/master/include/GL/gl3w.h"
        "${GL3W_DIR}/include/GL/gl3w.h"
    )
    file(DOWNLOAD
        "https://raw.githubusercontent.com/skaslev/gl3w/master/include/GL/glcorearb.h"
        "${GL3W_DIR}/include/GL/glcorearb.h"
    )
    file(DOWNLOAD
        "https://raw.githubusercontent.com/skaslev/gl3w/master/src/gl3w.c"
        "${GL3W_DIR}/src/gl3w.c"
    )
endif()

# Create testing stubs for Aeron
add_library(aeron_stub
    src/testing/AeronStub.cpp
)

target_include_directories(aeron_stub PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}/src
)

# Common library (with stubs for testing)
add_library(common
    src/common/TextMessage.cpp
    src/common/HealthMonitor.cpp
)

target_include_directories(common PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}/src
)

target_link_libraries(common aeron_stub)

# Sender application
add_executable(sender
    src/sender/main.cpp
    src/sender/SenderApp.cpp
    src/sender/TextMemory.cpp
    ${IMGUI_SOURCES}
)

target_include_directories(sender PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/src
    ${IMGUI_DIR}
    ${IMGUI_DIR}/backends
)

target_link_libraries(sender
    common
    glfw
    ${OPENGL_LIBRARIES}
)

# Receiver application
add_executable(receiver
    src/receiver/main.cpp
    src/receiver/ReceiverApp.cpp
    src/receiver/TextRenderer.cpp
    src/receiver/TextureSender.cpp
    ${GL3W_DIR}/src/gl3w.c
)

target_include_directories(receiver PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/src
    ${FREETYPE_INCLUDE_DIRS}
    ${GL3W_DIR}/include
)

target_compile_options(receiver PRIVATE ${FREETYPE_CFLAGS_OTHER})

target_link_libraries(receiver
    common
    glfw
    ${OPENGL_LIBRARIES}
    ${FREETYPE_LIBRARIES}
)

# Platform-specific libraries and frameworks
if(APPLE)
    # Find and link Syphon framework
    find_library(SYPHON_FRAMEWORK Syphon)
    find_library(COCOA_FRAMEWORK Cocoa)
    find_library(OPENGL_FRAMEWORK OpenGL)

    if(SYPHON_FRAMEWORK)
        target_link_libraries(receiver ${SYPHON_FRAMEWORK} ${COCOA_FRAMEWORK} ${OPENGL_FRAMEWORK})
        target_compile_definitions(receiver PRIVATE __APPLE__)
        message(STATUS "Found Syphon framework: ${SYPHON_FRAMEWORK}")
    else()
        message(WARNING "Syphon framework not found - Syphon support disabled")
    endif()
endif()

# Copy fonts directory to build directory
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/fonts)
    file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/fonts DESTINATION ${CMAKE_CURRENT_BINARY_DIR})
endif()